<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  {% include 'navbar.html' %}
  <style>
    ul.stats {
      list-style-type: none;
      padding: 0;
      font-size: 1.1em;
    }
    ul.stats li {
      padding: 6px 0;
    }
  </style>
</head>
<body>
  {% if profile and profile.resume_filename %}
    <div style="background:#e8f4fc; border: 1px solid #22aaff; padding:10px; margin-bottom:20px;">
      <strong>Resume on File:</strong>
      <a href="{{ url_for('view_resume', filename=profile.resume_filename) }}" target="_blank">
        📄 View / Download Resume
      </a>
    </div>
  {% endif %}

  <form action="{{ url_for('refresh_jobs') }}" method="get" style="display:inline; float:right; margin-top:10px;">
    <button type="submit" style="background:#3a8fff; color:#fff; border:none; padding:8px 16px; border-radius:4px;">
      🔄 Refresh Job List
    </button>
  </form>

  <h2>📊 Your Dashboard</h2>

  <!-- 📈 Stats Section -->
  <div style="border:1px solid #ccc; padding:15px; margin-bottom:20px;">
    <h3 style="margin-top:0;">📈 Application Stats</h3>
    <ul class="stats">
      <li><strong>✅ Total Jobs Applied:</strong> {{ stats.applied_total }}</li>
      <li><strong>📆 Applied This Week:</strong> {{ stats.applied_this_week }}</li>
      <li><strong>🛠 Manual Apply Left:</strong> {{ stats.manual_pending }}</li>
    </ul>
  </div>

  <!-- 🆕 New Jobs Panel -->
  <h3>🆕 New Jobs Added</h3>
  <div style="border:1px solid #007BFF; padding:15px; margin-bottom:20px;">
      <strong>{{ recent_jobs_day|length }} new jobs in the last 24 hours:</strong>
      <ul>
        {% for job in recent_jobs_day %}
          <li><a href="{{ job.link }}" target="_blank">{{ job.title }}</a> at {{ job.company }}</li>
        {% endfor %}
      </ul>
      <strong>{{ recent_jobs_week|length }} new jobs in the last week:</strong>
      <ul>
        {% for job in recent_jobs_week %}
          <li><a href="{{ job.link }}" target="_blank">{{ job.title }}</a> at {{ job.company }}</li>
        {% endfor %}
      </ul>
  </div>

  <!-- Weekly Application Trends Chart -->
  <h3>📊 Weekly Applications</h3>
  <div style="margin-bottom: 20px;">
    <canvas id="weeklyChart" width="400" height="150"></canvas>
  </div>

  <!-- Inject Jinja variables into window object before main chart.js script -->
  <script>
    window.WEEKLY_LABELS = {{ week_labels|tojson }};
    window.WEEKLY_COUNTS = {{ week_counts|tojson }};
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = window.WEEKLY_LABELS;
    const counts = window.WEEKLY_COUNTS;

    const ctx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Applications per Week',
                data: counts,
                backgroundColor: '#3a8fff',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0 // Ensure y-axis labels are integers
                    }
                }
            }
        }
    });
  </script>

  <h3>🎯 Matching Jobs</h3>
  {% if jobs %}
    <ul>
      {% for job in jobs %}
        <li>
          <strong>{{ job.title }}</strong> @ {{ job.company }}<br>
          <a href="{{ job.link }}" target="_blank">View Job</a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No matching jobs found.</p>
  {% endif %}

  {% if session.job_log %}
    <h3>📝 Log History</h3>
    <ul>
      {% for log in session.job_log[-10:] %}
        <li>{{ log }}</li>
      {% endfor %}
    </ul>
    <form action="{{ url_for('clear_log') }}" method="get" style="margin-top:10px;">
      <button type="submit">🧹 Clear History</button>
    </form>
  {% endif %}
</body>
</html> 