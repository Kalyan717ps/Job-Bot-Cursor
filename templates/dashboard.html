<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Job Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- TailwindCSS & Work Sans for style -->
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Work Sans', sans-serif;
      background-color: #f8fafe;
    }
    .stat-value {
      font-weight: 700;
      font-size: 2.5rem;
      color: #2e77f1;
    }
    .stat-label {
      color: #6b7280;
      font-size: 0.95rem;
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  {% include 'navbar.html' %}

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-7">
    <!-- Resume Card -->
    {% if profile and profile.resume_filename %}
      <section class="rounded-xl bg-white shadow border flex flex-col sm:flex-row items-center p-6 gap-7">
        <div class="flex-1">
          <div class="font-semibold text-xl text-gray-800">Resume on File</div>
          <div class="text-gray-500 text-sm mt-1 mb-2">{{ profile.resume_filename }}</div>
          <a href="{{ url_for('view_resume', filename=profile.resume_filename) }}"
             class="inline-block bg-blue-600 text-white px-4 py-2 rounded-md mt-4 font-medium hover:bg-blue-700 transition"
             target="_blank">View / Download Resume</a>
        </div>
      </section>
    {% endif %}

    <!-- Dashboard header + Refresh -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
      <h2 class="mb-6 text-3xl font-bold">
        Hello, {{ current_user.first_name }}
      </h2>
      
      <form action="{{ url_for('refresh_jobs') }}" method="get">
        <button type="submit" class="bg-blue-500 px-4 py-2 rounded-md text-white font-semibold hover:bg-blue-600 transition">ðŸ”„ Refresh Job List</button>
      </form>
    </div>

    <!-- Stats Cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow border p-6 flex flex-col items-start">
        <span class="stat-label">Total Jobs Applied</span>
        <span class="stat-value mt-2">{{ stats.applied_total }}</span>
      </div>
      <div class="bg-white rounded-xl shadow border p-6 flex flex-col items-start">
        <span class="stat-label">Applied This Week</span>
        <span class="stat-value mt-2">{{ stats.applied_this_week }}</span>
      </div>
      <div class="bg-white rounded-xl shadow border p-6 flex flex-col items-start">
        <span class="stat-label">Manual Apply Left</span>
        <span class="stat-value mt-2">{{ stats.manual_pending }}</span>
      </div>
    </section>

    <!-- New Jobs Panel -->
    <section class="bg-white rounded-xl shadow border p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">New Jobs</h2>
      <div class="mb-3">
        <h3 class="text-blue-600 font-medium text-sm">{{ recent_jobs_day|length }} jobs in the last 24 hours</h3>
        <ul class="list-disc list-inside mt-1 space-y-1 text-sm">
          {% for job in recent_jobs_day %}
            <li>
              <span class="font-medium">{{ job.title }}</span> at {{ job.company }}
              <a href="{{ job.link }}" target="_blank" class="ml-2 text-blue-600 underline">View Job</a>
            </li>
          {% endfor %}
        </ul>
      </div>
      <div>
        <h3 class="text-blue-600 font-medium text-sm mt-4">{{ recent_jobs_week|length }} jobs in the last 7 days</h3>
        <ul class="list-disc list-inside mt-1 space-y-1 text-sm">
          {% for job in recent_jobs_week %}
            <li>
              <span class="font-medium">{{ job.title }}</span> at {{ job.company }}
              <a href="{{ job.link }}" target="_blank" class="ml-2 text-blue-600 underline">View Job</a>
            </li>
          {% endfor %}
        </ul>
      </div>
    </section>

    <!-- Weekly Trends Chart -->
    <section class="flex flex-col gap-2 bg-white rounded-xl shadow border p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Weekly Applications</h2>
      <canvas id="weeklyChart" class="w-full h-56"></canvas>
    </section>

    <!-- Matching Jobs -->
    <section class="bg-white rounded-xl shadow border p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Matching Jobs</h2>
      {% if jobs %}
        <ul class="divide-y divide-gray-200">
          {% for job in jobs %}
            <li class="py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>
                <span class="font-semibold">{{ job.title }}</span>
                <span class="text-gray-500">at</span>
                <span class="font-medium text-gray-900">{{ job.company }}</span>
              </div>
              <a href="{{ job.link }}" target="_blank" class="text-blue-600 underline text-sm font-medium">View Job</a>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-500">No matching jobs found.</p>
      {% endif %}
    </section>

    <!-- Log History -->
    {% if session.job_log %}
    <section class="bg-white rounded-xl shadow border p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">Log History</h2>
        <form action="{{ url_for('clear_log') }}" method="get">
          <button type="submit" class="text-red-500 text-sm rounded px-2 py-1 hover:bg-red-50">ðŸ§¹ Clear History</button>
        </form>
      </div>
      <ul class="max-h-40 overflow-y-auto text-sm text-gray-700 space-y-1">
        {% for log in session.job_log[-10:] %}
          <li>â€¢ {{ log }}</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </main>

  <!-- Chart.js for Weekly Trends -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ week_labels | tojson }},
        datasets: [{
          label: 'Applications per Week',
          data: {{ week_counts | tojson }},
          backgroundColor: '#2563eb',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        }
      }
    });
  </script>
</body>
</html>
